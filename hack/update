#!/bin/bash
#
# This generates our Dockerfiles for various containers
# used within AusNimbus
#
# The following ENV variables are expected to be included:
#
#   - $VERSIONS (comma seperated versions to generate)
#   - $FROM (overwrides the FROM layout defaults to %NAME%:%VERSION%-%VARIANT%)
#   - $TEMPLATES (comma seperated templates - in order)
#   - $VARIANT (eg. alpine)
#

FROM=${FROM:-"%NAME%:%VERSION%-%VARIANT%"}

pushd $(readlink -zf $(dirname "${BASH_SOURCE[0]}")) >/dev/null
cd ..

# Loop through the required versions
for version in ${VERSIONS//,/ }; do
  file=../versions/$version/Dockerfile

  echo -e '#\n# NOTE: THIS DOCKERFILE IS GENERATED VIA "./hack/run update"\n#\n# DO NOT EDIT IT DIRECTLY.\n#' > $file
  echo -e "FROM $FROM" >> $file

  # Loop through the templates
  for template in ${TEMPLATES//,/ }; do
    echo -e "# <$template>\n" >> $file
    if [ $template == 'template' ]; then
      cat ../Dockerfile.template >> $file
    else
      cat templates/$template-$VARIANT.template >> $file
    fi
    echo -e "\n# </$template>" >> $file
  done

  sed -e "s;%NAME%;$NAME;g" \
      -e "s;%VERSION%;$version;g" \
      -e "s;%DISPLAY_NAME%;$DISPLAY_NAME;g" \
      -i $file
done
popd >/dev/null

echo "Parsed all Dockerfiles"
